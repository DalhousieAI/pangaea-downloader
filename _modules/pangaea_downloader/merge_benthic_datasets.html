

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pangaea_downloader.merge_benthic_datasets &#8212; pangaea-downloader 0.1.dev0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/rtd_sphinx_search.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="../../_static/js/rtd_search_config.js"></script>
    <script src="../../_static/js/rtd_sphinx_search.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pangaea_downloader/merge_benthic_datasets';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">pangaea-downloader 0.1.dev0 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../source/programs/programs.html">CLI Reference</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../source/packages/modules.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../source/packages/pangaea_downloader.html">pangaea_downloader package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../source/packages/pangaea_downloader.tools.html">pangaea_downloader.tools package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../source/packages/pangaea_downloader.tools.checker.html">pangaea_downloader.tools.checker module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../source/packages/pangaea_downloader.tools.datasets.html">pangaea_downloader.tools.datasets module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../source/packages/pangaea_downloader.tools.eda.html">pangaea_downloader.tools.eda module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../source/packages/pangaea_downloader.tools.process.html">pangaea_downloader.tools.process module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../source/packages/pangaea_downloader.tools.requesting.html">pangaea_downloader.tools.requesting module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../source/packages/pangaea_downloader.tools.scraper.html">pangaea_downloader.tools.scraper module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../source/packages/pangaea_downloader.tools.search.html">pangaea_downloader.tools.search module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../source/packages/pangaea_downloader.citations.html">pangaea_downloader.citations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../source/packages/pangaea_downloader.concat_datasets.html">pangaea_downloader.concat_datasets module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../source/packages/pangaea_downloader.exclude_datasets.html">pangaea_downloader.exclude_datasets module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../source/packages/pangaea_downloader.fix_col_names.html">pangaea_downloader.fix_col_names module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../source/packages/pangaea_downloader.licenses.html">pangaea_downloader.licenses module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html">pangaea_downloader.merge_benthic_datasets module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../source/packages/pangaea_downloader.pq_scraper.html">pangaea_downloader.pq_scraper module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../py-modindex.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../genindex.html">Index</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">



<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for pangaea_downloader.merge_benthic_datasets</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Merge benthic PANGAEA datasets together, in BenthicNet format.</span>

<span class="sd">Search results are filtered to ensure they are images of the seafloor.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">from</span> <span class="nn">pandas.api.types</span> <span class="kn">import</span> <span class="n">is_numeric_dtype</span>
<span class="kn">from</span> <span class="nn">pangaeapy</span> <span class="kn">import</span> <span class="n">PanDataSet</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">pangaea_downloader</span> <span class="kn">import</span> <span class="n">__meta__</span>
<span class="kn">from</span> <span class="nn">pangaea_downloader.tools</span> <span class="kn">import</span> <span class="n">checker</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">benthicnet.io</span> <span class="kn">import</span> <span class="n">fixup_repeated_output_paths</span><span class="p">,</span> <span class="n">row2basename</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">fixup_repeated_output_paths</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">row2basename</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Create new `pandas` methods which use `tqdm` progress</span>
<span class="c1"># (can use tqdm_gui, optional kwargs, etc.)</span>
<span class="n">tqdm</span><span class="o">.</span><span class="n">pandas</span><span class="p">()</span>

<span class="n">TAXONOMY_RANKS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;Kingdom&quot;</span><span class="p">,</span> <span class="s2">&quot;Regnum&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;Phylum&quot;</span><span class="p">,</span> <span class="s2">&quot;Division&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;Ordo&quot;</span><span class="p">,</span> <span class="s2">&quot;Order&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;Familia&quot;</span><span class="p">,</span> <span class="s2">&quot;Family&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;Genus&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;Species&quot;</span><span class="p">],</span>
<span class="p">]</span>


<div class="viewcode-block" id="row2taxonomy"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.row2taxonomy">[docs]</a><span class="k">def</span> <span class="nf">row2taxonomy</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge together taxonomical rows into a single field.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rank_synonyms</span> <span class="ow">in</span> <span class="n">TAXONOMY_RANKS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">rank_synonyms</span><span class="p">:</span>
            <span class="n">col_</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">col_</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">col_</span><span class="p">]</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">col_</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col_</span><span class="p">])</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="s2">&quot; &gt; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span></div>


<div class="viewcode-block" id="find_url_column"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.find_url_column">[docs]</a><span class="k">def</span> <span class="nf">find_url_column</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the name of the column containing image URL.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Dataframe</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    column : str or None</span>
<span class="sd">        The name of the best-guess column for the image URL, or None if no</span>
<span class="sd">        such column could be found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Change to lower case and strip away any non-alphanumeric characters which</span>
    <span class="c1"># would stop us seeing an appropriate column</span>
    <span class="n">clean_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">]</span>
    <span class="c1"># Ordered list of priorities</span>
    <span class="c1"># Exclude url meta/ref/source which are not links to images</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;urlimage&quot;</span><span class="p">,</span>
        <span class="s2">&quot;urlraw&quot;</span><span class="p">,</span>
        <span class="s2">&quot;urlfile&quot;</span><span class="p">,</span>
        <span class="s2">&quot;url&quot;</span><span class="p">,</span>
        <span class="s2">&quot;urlgraphic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;urlthumb&quot;</span><span class="p">,</span>
        <span class="s2">&quot;urlthumbnail&quot;</span><span class="p">,</span>
        <span class="s2">&quot;image&quot;</span><span class="p">,</span>
        <span class="s2">&quot;imagery&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">candidate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clean_cols</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">clean_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">candidate</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">checker</span><span class="o">.</span><span class="n">is_url</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">col</span></div>


<div class="viewcode-block" id="add_file_extension"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.add_file_extension">[docs]</a><span class="k">def</span> <span class="nf">add_file_extension</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add file extension to image filename.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    row : dict</span>
<span class="sd">        A dict record which may have fields ``&quot;image&quot;``, ``&quot;File format&quot;``,</span>
<span class="sd">        and ``&quot;File type&quot;``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fname : str</span>
<span class="sd">        File name with extension included.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If there is no image column, there is nothing to add an extension to</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;image&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="ow">or</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
        <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Check to see if the image column has an extension. If it seems like it</span>
    <span class="c1"># does, it might actually just be a dot in the middle of the file name,</span>
    <span class="c1"># so we check the perceived extension to make sure it&#39;s actually an</span>
    <span class="c1"># extension-like string</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">s</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="ow">in</span> <span class="n">checker</span><span class="o">.</span><span class="n">VALID_IMG_EXTENSIONS</span>
        <span class="o">+</span> <span class="n">checker</span><span class="o">.</span><span class="n">INVALID_FILE_EXTENSIONS</span>
        <span class="o">+</span> <span class="n">checker</span><span class="o">.</span><span class="n">COMPRESSED_FILE_EXTENSIONS</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="c1"># If there was no extension found on the image, check to see if there is</span>
    <span class="c1"># a File format or File type field.</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;File format&quot;</span><span class="p">,</span> <span class="s2">&quot;File type&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">new_ext</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_ext</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_ext</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">new_ext</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">new_ext</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="n">new_ext</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">new_ext</span>
        <span class="k">break</span>

    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="check_title"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.check_title">[docs]</a><span class="k">def</span> <span class="nf">check_title</span><span class="p">(</span><span class="n">title</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check dataset title is acceptable for benthic habitat imagery.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    title : str</span>
<span class="sd">        The title of the dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether the dataset title is acceptable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;do not use&quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Meteorological observations&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Sea ice conditions&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;topsoil&quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;core&quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="c1"># return False</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="s2">&quot;aquarium&quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot; of the early life history &quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;grab sample&quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Calyx growth&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;dried glass sponges&quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;fresh glass sponges&quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;spicule preparations&quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Shell growth increments&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">title</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Images of shell cross sections&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;early biofouling processes in a coastal lagoon&quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="ow">or</span> <span class="s2">&quot;early biofouling processes in a coastal la goon&quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s2">&quot;photographs of tiles&quot;</span> <span class="ow">in</span> <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="reformat_df"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.reformat_df">[docs]</a><span class="k">def</span> <span class="nf">reformat_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">remove_duplicate_columns</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reformat a PANGAEA dataset to have standardized column names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Original dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame or None</span>
<span class="sd">        Cleaned dataset, or ``None`` if the dataset is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check the title is okay, otherwise don&#39;t bother cleaning the dataframe</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;dataset_title&quot;</span> <span class="ow">in</span> <span class="n">df</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dataset_title&quot;</span><span class="p">]</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">check_title</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dataset_title&quot;</span><span class="p">])</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Make a copy of the dataframe so we can&#39;t overwrite the input</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Get dataset id from first row</span>
    <span class="n">ds_id</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ds_id&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">ds_id</span> <span class="o">=</span> <span class="n">ds_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Handle Area column</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Area&quot;</span><span class="p">,</span> <span class="s2">&quot;Area_2&quot;</span><span class="p">,</span> <span class="s2">&quot;Area_3&quot;</span><span class="p">]:</span>
        <span class="c1"># Area is sometimes the seafloor surface area of the image in</span>
        <span class="c1"># meters^2 and sometimes used as a synonym for location</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span> <span class="ow">and</span> <span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Using </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> for area measurement&quot;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="s2">&quot;area&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="c1"># Remove duplicately named columns</span>
    <span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">remove_duplicate_columns</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot; _&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&quot;123456789&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">col</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">cols_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Remove bad columns</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="c1"># Find the correct URL column, and drop other columns containing &quot;url&quot;</span>
    <span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">col_url</span> <span class="o">=</span> <span class="n">find_url_column</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">mapping</span><span class="p">[</span><span class="n">col_url</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;url&quot;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">col_url</span> <span class="ow">and</span> <span class="s2">&quot;url&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="c1"># Search for matches to canonical columns.</span>
    <span class="c1"># Each entry in desired_columns is a key, value pair where the key</span>
    <span class="c1"># is the output column name, and the value is a list of search names</span>
    <span class="c1"># in order of priority. The first match will be kept and others discarded.</span>
    <span class="n">desired_columns</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;url_thumbnail&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;urlthumb&quot;</span><span class="p">,</span> <span class="s2">&quot;urlthumbnail&quot;</span><span class="p">],</span>
        <span class="s2">&quot;dataset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ds_id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;site&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Event&quot;</span><span class="p">,</span> <span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="s2">&quot;deployment&quot;</span><span class="p">],</span>
        <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
        <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;Date/Time&quot;</span><span class="p">,</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date/timestart&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date/timeend&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;Latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude+&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitudemed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitudenorth&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;latitudesouth&quot;,  # special handling</span>
        <span class="p">],</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;Longitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;long&quot;</span><span class="p">,</span>
            <span class="s2">&quot;longitude+&quot;</span><span class="p">,</span>
            <span class="s2">&quot;longitudemed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;longitudeeast&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;longitudewest&quot;,  # special handling</span>
        <span class="p">],</span>
        <span class="s2">&quot;x_pos&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;y_pos&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;altitude&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;altitude&quot;</span><span class="p">,</span> <span class="s2">&quot;heightaboveseafloor&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">],</span>
        <span class="s2">&quot;depth_camera&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;depthwater&quot;</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">],</span>
        <span class="s2">&quot;depth_seafloor&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bathydepth&quot;</span><span class="p">,</span> <span class="s2">&quot;bathymetry&quot;</span><span class="p">,</span> <span class="s2">&quot;bathy&quot;</span><span class="p">],</span>
        <span class="s2">&quot;elevation&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;elevation&quot;</span><span class="p">],</span>
        <span class="s2">&quot;backscatter&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">],</span>
        <span class="s2">&quot;salinity&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;salinity&quot;</span><span class="p">,</span> <span class="s2">&quot;sal&quot;</span><span class="p">],</span>
        <span class="s2">&quot;chlorophyll&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;acidity&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pH&quot;</span><span class="p">],</span>
        <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;DOI&quot;</span><span class="p">,</span> <span class="s2">&quot;doi&quot;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="c1"># Remove non-alphanumeric padding characters, including spaces, from actual column names</span>
    <span class="n">raw_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">clean_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">]</span>
    <span class="c1"># Map to lower case</span>
    <span class="n">lower_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">clean_cols</span><span class="p">]</span>

    <span class="c1"># Search for matching column names</span>
    <span class="k">for</span> <span class="n">canon</span><span class="p">,</span> <span class="n">searches</span> <span class="ow">in</span> <span class="n">desired_columns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Check for case-sensitive, non-alphanumeric, match</span>
        <span class="k">for</span> <span class="n">search</span> <span class="ow">in</span> <span class="n">searches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">search</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">raw_cols</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">search</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">mapping</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">canon</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_drop</span><span class="p">:</span>
                    <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">canon</span> <span class="ow">and</span> <span class="n">canon</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">canon</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_drop</span><span class="p">:</span>
                <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="c1"># Check for case-sensitive match</span>
        <span class="k">for</span> <span class="n">search</span> <span class="ow">in</span> <span class="n">searches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">search</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clean_cols</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">clean_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">search</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">mapping</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">canon</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_drop</span><span class="p">:</span>
                    <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">canon</span> <span class="ow">and</span> <span class="n">canon</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">canon</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_drop</span><span class="p">:</span>
                <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="c1"># Check for case-insensitive match</span>
        <span class="k">for</span> <span class="n">search</span> <span class="ow">in</span> <span class="n">searches</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">search</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lower_cols</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">lower_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">mapping</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">canon</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_drop</span><span class="p">:</span>
                    <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">canon</span> <span class="ow">and</span> <span class="n">canon</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">canon</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_drop</span><span class="p">:</span>
                <span class="n">cols_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="c1"># Remove superfluous columns</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">cols_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Rename columns to canonical names</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">mapping</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span>

    <span class="c1"># Handle latitudesouth and longitudewest</span>
    <span class="k">if</span> <span class="s2">&quot;latitude&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;latitudesouth&quot;</span> <span class="ow">in</span> <span class="n">lower_cols</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">lower_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;latitudesouth&quot;</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;latitude&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;latitude-&quot;</span> <span class="ow">in</span> <span class="n">lower_cols</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">lower_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;latitude-&quot;</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;longitude&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;longitudewest&quot;</span> <span class="ow">in</span> <span class="n">lower_cols</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">lower_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;longitudewest&quot;</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;longitude&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;longitude-&quot;</span> <span class="ow">in</span> <span class="n">lower_cols</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">lower_cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;longitude-&quot;</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

    <span class="c1"># Remove datapoints with erroneous negative depth</span>
    <span class="k">if</span> <span class="s2">&quot;depth_of_observer&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Only observed two datapoints where this happens</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;depth_of_observer&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;depth_of_observer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>

    <span class="c1"># Add file extension to image</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">add_file_extension</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># if &quot;timestamp&quot; not in df.columns and &quot;datetime&quot; in df.columns:</span>
    <span class="c1">#     df[&quot;timestamp&quot;] = df[&quot;datetime&quot;].apply(datetime2timestamp)</span>

    <span class="c1"># Add default site if it is missing</span>
    <span class="k">if</span> <span class="s2">&quot;site&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_site&quot;</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">clean_cols</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Kingdom&quot;</span><span class="p">,</span> <span class="s2">&quot;Phylum&quot;</span><span class="p">,</span> <span class="s2">&quot;Genus&quot;</span><span class="p">]):</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;taxonomy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">row2taxonomy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">TAXONOMY_RANKS</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">syn</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;File format&quot;</span><span class="p">,</span>
        <span class="s2">&quot;File type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;File size&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Date/Time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Date/time end&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">cols_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="check_image_url"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.check_image_url">[docs]</a><span class="k">def</span> <span class="nf">check_image_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check image URL is acceptable for benthic habitat imagery.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        The image url.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Whether the image URL is acceptable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">banned_subdomains</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;https://doi.org/10.1594/PANGAEA&quot;</span><span class="p">,</span>
        <span class="s2">&quot;http://epic.awi.de/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://epic.awi.de/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;http://hdl.handle.net/10013/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;http://library.ucsd.edu/dc/object/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://app.geosamples.org/uploads/UHM/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/Linescan/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Maps/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de//Maps&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Movies/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Projects/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/bathy/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/fishsounder/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/mag/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/model/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/nav/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/palaoa/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/pasata/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/para/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/polar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/reflec/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/sat/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://prr.osu.edu/collection/object/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://store.pangaea.de/Projects/&quot;</span><span class="p">,</span>  <span class="c1"># Not all bad, but mostly</span>
        <span class="s2">&quot;https://store.pangaea.de/Publications/&quot;</span><span class="p">,</span>  <span class="c1"># Not all bad, but mostly</span>
        <span class="s2">&quot;https://store.pangaea.de/software/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://www.ngdc.noaa.gov/geosamples/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/Airphoto/&quot;</span><span class="p">,</span>
        <span class="c1"># &quot;https://hs.pangaea.de/Images/Cores/&quot;,  # Some of these are okay</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/Documentation/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/Maps/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/MMT/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/Plankton/&quot;</span><span class="p">,</span>
        <span class="c1"># The GeoB19346-1 dataset contains .bmp images of the ROV&#39;s sonar</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/ROV/M/M114/GeoB19346-1/data_publish/data/sonar/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/Satellite/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/SeaIce/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/Water/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://store.pangaea.de/Images/Airphoto/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://store.pangaea.de/Images/Documentation/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/Benthos/AWI_experimental_aquarium_system/&quot;</span><span class="p">,</span>
        <span class="c1"># &quot;https://hs.pangaea.de/Images/Benthos/AntGlassSponges&quot;,  # Only okay if it contains &quot;AHEAD&quot;</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/Benthos/Kongsfjorden/MHerrmann/&quot;</span><span class="p">,</span>  <span class="c1"># Microscope images</span>
        <span class="s2">&quot;https://hs.pangaea.de/Images/Benthos/Kongsfjorden/Brandal/&quot;</span><span class="p">,</span>  <span class="c1"># Cross-sections</span>
    <span class="p">]</span>
    <span class="n">banned_words</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;aquarium&quot;</span><span class="p">,</span>
        <span class="s2">&quot;map&quot;</span><span class="p">,</span>
        <span class="s2">&quot;divemap&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dredgephotos&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dredge_photos&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dredgephotograph&quot;</span><span class="p">,</span>
        <span class="s2">&quot;grabsample&quot;</span><span class="p">,</span>
        <span class="s2">&quot;grab_sample&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Check if the URL is on any of the banned subdomains known to contain the</span>
    <span class="c1"># wrong sort of images</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">banned_subdomains</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check if the URL contains a banned word indicating it is of metadata or</span>
    <span class="c1"># samples taken away from the seafloor</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">banned_words</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(?&lt;![A-Za-z])&quot;</span> <span class="o">+</span> <span class="n">word</span> <span class="o">+</span> <span class="s2">&quot;(?![A-Za-z])&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;(?&lt;![a-z])core(?![a-rty])&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="s2">&quot;SUR&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="c1"># Images of cores must contain &quot;SURFACE&quot;, or the shorthand &quot;SUR&quot;</span>
        <span class="c1"># We only keep the ones with surface in uppercase, because those</span>
        <span class="c1"># experiments are in-situ surface photos, whereas lower case are not.</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https://hs.pangaea.de/Images/Benthos/AntGlassSponges/&quot;</span><span class="p">)</span>
        <span class="ow">and</span> <span class="s2">&quot;AHEAD&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span>
        <span class="ow">and</span> <span class="s2">&quot;DOWN&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span>
    <span class="p">):</span>
        <span class="c1"># Images of AntGlassSponges must contain &quot;AHEAD&quot; to be kept</span>
        <span class="c1"># otherwise, they are of sponges after removal</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s2">&quot;not_available&quot;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="filter_urls"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.filter_urls">[docs]</a><span class="k">def</span> <span class="nf">filter_urls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">url_column</span><span class="o">=</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove unwanted URLs from the dataset.</span>

<span class="sd">    Remove invalid URLs (file paths, etc), filter out off-topic URLs by their</span>
<span class="sd">    subdomain and checking for blacklisted keywords, and remove URLs which</span>
<span class="sd">    are not images. We also remove any mosaic images.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The dataset to filter.</span>
<span class="sd">    url_column : str, default=&quot;url&quot;</span>
<span class="sd">        The name of the column containing image URLs, which will be filtered.</span>
<span class="sd">    inplace : bool, default=True</span>
<span class="sd">        Whether to adjust the input dataframe, otherwise a copy will be used.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The dataset, with rows removed if they were deemed to have bad URLs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># Filter down to only valid URLs</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">url_column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">checker</span><span class="o">.</span><span class="n">is_url</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># Remove bad subdomains and blacklisted words</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">url_column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">check_image_url</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># Filter down to only rows which have image extension</span>
    <span class="n">is_image</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">url_column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">checker</span><span class="o">.</span><span class="n">has_img_extension</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="s2">&quot;image&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">is_image</span> <span class="o">|=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">checker</span><span class="o">.</span><span class="n">has_img_extension</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">is_image</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># Drop mosaic images</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">url_column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;mosaic&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())]</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="fixup_url_with_image"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.fixup_url_with_image">[docs]</a><span class="k">def</span> <span class="nf">fixup_url_with_image</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace the end of the URL field with the contents of the image field.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    row : dict</span>
<span class="sd">        Dictionary containing one record, with keys ``&quot;url&quot;`` and (optionally)</span>
<span class="sd">        ``&quot;image&quot;``. If there is no ``&quot;image&quot;`` key, the URL will not be</span>
<span class="sd">        changed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    url_new : str</span>
<span class="sd">        New image URL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url_old</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;image&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">url_old</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">url_old</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/ &quot;</span><span class="p">)</span>
    <span class="n">url_parts</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">url_parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">url_new</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url_parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext</span> <span class="o">==</span> <span class="n">url_parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">url</span>
    <span class="n">url_new</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">url_new</span></div>


<div class="viewcode-block" id="insert_rows"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.insert_rows">[docs]</a><span class="k">def</span> <span class="nf">insert_rows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Insert rows into a DataFrame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The dataset to add rows to.</span>
<span class="sd">    rows : list of dict</span>
<span class="sd">        The rows to add to the DataFrame.</span>
<span class="sd">    indices : list of int</span>
<span class="sd">        The indices at which the rows will be inserted.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        New dataframe, with rows added.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">[:</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]])]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="n">indices</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">rows</span><span class="p">[</span><span class="n">j</span><span class="p">]]))</span>
    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">:])</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span></div>


<div class="viewcode-block" id="fixup_repeated_urls"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.fixup_repeated_urls">[docs]</a><span class="k">def</span> <span class="nf">fixup_repeated_urls</span><span class="p">(</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">url_column</span><span class="o">=</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force_keep_original</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Change rows with repeated URLs to use their image field for the URL instead.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The dataset to process.</span>
<span class="sd">    url_column : str, default=&quot;url&quot;</span>
<span class="sd">        Name of the column in ``df`` containing image URLs.</span>
<span class="sd">    inplace : bool, default=True</span>
<span class="sd">        Whether to update the input ``df``. Otherwise a copy is returned.</span>
<span class="sd">    force_keep_original : bool, default=True</span>
<span class="sd">        Whether to ensure that original URLs still exist in the output by</span>
<span class="sd">        copying the first row containing a repeated URL if all original</span>
<span class="sd">        duplicates found new URLs.</span>
<span class="sd">    verbose : int, default=1</span>
<span class="sd">        Level of verbosity.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The dataset, with repeated URLs adjusted to use their image field</span>
<span class="sd">        instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">dup_urls</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">url_column</span><span class="p">)][</span><span class="n">url_column</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;image&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dup_urls</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Can&#39;t clean </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dup_urls</span><span class="p">)</span><span class="si">}</span><span class="s2"> repeated URLs in </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ds_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> without &#39;image&#39; column&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dup_urls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;dataset&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dup_urls</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicated URLs&quot;</span><span class="p">)</span>
    <span class="n">rows_to_insert</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">indices_to_insert_at</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">dup_url</span> <span class="ow">in</span> <span class="n">dup_urls</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">dup_url</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">is_bad_url</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">url_column</span><span class="p">]</span> <span class="o">==</span> <span class="n">dup_url</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">n_to_change</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">is_bad_url</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fixing up </span><span class="si">{</span><span class="n">n_to_change</span><span class="si">}</span><span class="s2"> repetitions of the URL </span><span class="si">{</span><span class="n">dup_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">first_row_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">is_bad_url</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">force_keep_original</span><span class="p">:</span>
            <span class="c1"># first_row = df[is_bad_url].iloc[0].copy()</span>
            <span class="n">first_row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">first_row_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_bad_url</span><span class="p">,</span> <span class="n">url_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">is_bad_url</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">fixup_url_with_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">n_remain</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_bad_url</span><span class="p">,</span> <span class="n">url_column</span><span class="p">]</span> <span class="o">==</span> <span class="n">dup_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_remain</span> <span class="o">==</span> <span class="n">n_to_change</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  All </span><span class="si">{</span><span class="n">n_to_change</span><span class="si">}</span><span class="s2"> URLs left unchanged&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">n_remain</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">n_to_change</span><span class="si">}</span><span class="s2"> URLs remain unchanged&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  After:&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_bad_url</span><span class="p">,</span> <span class="n">url_column</span><span class="p">][:</span><span class="mi">5</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n_to_change</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    ...&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_bad_url</span><span class="p">,</span> <span class="n">url_column</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">force_keep_original</span> <span class="ow">and</span> <span class="n">n_remain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Duplicating a row since the URL </span><span class="si">{</span><span class="n">dup_url</span><span class="si">}</span><span class="s2"> no longer appears&quot;</span><span class="p">)</span>
            <span class="n">first_row</span><span class="p">[</span><span class="n">url_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">dup_url</span>
            <span class="n">rows_to_insert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_row</span><span class="p">)</span>
            <span class="n">indices_to_insert_at</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_row_idx</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows_to_insert</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Inserting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rows_to_insert</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicated rows&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">insert_rows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rows_to_insert</span><span class="p">,</span> <span class="n">indices_to_insert_at</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="fixup_favourite_images"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.fixup_favourite_images">[docs]</a><span class="k">def</span> <span class="nf">fixup_favourite_images</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drop duplicated favourite images.</span>

<span class="sd">    These occur in Schewe and Bergmann&#39;s datasets along OFOS profiles during</span>
<span class="sd">    POLARSTERN cruises, PANGAEA dataset ids 849814--849816. 873995--874002,</span>
<span class="sd">    895102--895104, 896545--896549, 896653--896657, 912471.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        A PANGAEA dataframe with Type column.</span>
<span class="sd">    verbose : int, default=1</span>
<span class="sd">        Level of verbosity.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        As input dataframe, but with all Type entries starting with favourite</span>
<span class="sd">        removed (case-insensitive).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_samples_before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;Type&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Remove all Favourite timer, Favourite hotkey, FAVOURITE_TIMER, and</span>
        <span class="c1"># FAVOURITE_HOTKEY entries, which although they have unique URLs for their</span>
        <span class="c1"># images are actually identical images to the ones occuring immediately</span>
        <span class="c1"># after them in the dataframe.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;favourite&quot;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="s2">&quot;image&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Check if the image filename field is repeated except for a leading</span>
        <span class="c1"># &quot;FAVOURITE_&quot; string, if so remove it. These images are identical</span>
        <span class="c1"># copies of the other images.</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;favourite&quot;</span><span class="p">)</span>
        <span class="n">image_tmp</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;FAVOURITE_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">is_repeated</span> <span class="o">=</span> <span class="n">image_tmp</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Remove favourite images which are repeated</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">select</span> <span class="o">&amp;</span> <span class="n">is_repeated</span><span class="p">)]</span>
    <span class="n">n_samples_after</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n_samples_after</span> <span class="o">!=</span> <span class="n">n_samples_before</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; Removed </span><span class="si">{</span><span class="n">n_samples_before</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n_samples_after</span><span class="si">}</span><span class="s2"> favourited images.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">n_samples_before</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">n_samples_after</span><span class="si">}</span><span class="s2"> rows&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="get_dataset_datetime"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.get_dataset_datetime">[docs]</a><span class="k">def</span> <span class="nf">get_dataset_datetime</span><span class="p">(</span><span class="n">ds_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine a generic date for a dataset from the min and max extent datetimes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds_id : int</span>
<span class="sd">        The identifier of a PANGAEA dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dt_avg : str</span>
<span class="sd">        The average datetime between the min and max extent, with precision</span>
<span class="sd">        reduced to reflect what can accurately be represented.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">PanDataSet</span><span class="p">(</span><span class="n">ds_id</span><span class="p">,</span> <span class="n">enable_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dt_min</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">mintimeextent</span><span class="p">)</span>
    <span class="n">dt_max</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">maxtimeextent</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dt_min</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dt_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
    <span class="k">elif</span> <span class="n">dt_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dt_max</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dt_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dt_min</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">dt_max</span> <span class="o">-</span> <span class="n">dt_min</span>
    <span class="n">dt_avg</span> <span class="o">=</span> <span class="n">dt_min</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dt_avg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dt_avg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dt_avg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dt_avg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:00:00&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">dt_avg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:00&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dt_avg</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="fix_missing_datetime_from_image_name"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.fix_missing_datetime_from_image_name">[docs]</a><span class="k">def</span> <span class="nf">fix_missing_datetime_from_image_name</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ds_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract datetime information from the contents of the image column in the dataframe.</span>

<span class="sd">    Note that the extraction operation is only performed on dataset IDs for</span>
<span class="sd">    which the image naming scheme has been manually evaluated, and is not</span>
<span class="sd">    applied blindly to datasets which have not been inspected.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input dataframe.</span>
<span class="sd">    ds_id : int</span>
<span class="sd">        The identifier of the PANGAEA dataset.</span>
<span class="sd">    verbose : int, default=1</span>
<span class="sd">        Verbosity level.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        As input, but with missing datetime cells filled in from the image.</span>
<span class="sd">        Existing datetime values are unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;datetime&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

    <span class="n">ds_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ds_id</span><span class="p">)</span>

    <span class="n">select</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">row2basename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">selected_image</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selected_image</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">select</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">partial</span><span class="p">(</span><span class="n">row2basename</span><span class="p">,</span> <span class="n">use_url_extension</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

    <span class="n">selected_image_no_ext</span> <span class="o">=</span> <span class="n">selected_image</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="mi">371062</span> <span class="o">&lt;=</span> <span class="n">ds_id</span> <span class="o">&lt;=</span> <span class="mi">371064</span><span class="p">:</span>
        <span class="c1"># e.g. PO309_41-1_2004-04-05T08_55_41.jpg</span>
        <span class="c1"># e.g. PO309_41-2-1_2004-04-05T11_28_26.jpg</span>
        <span class="c1"># e.g. PO322_211-4-1_2005-05-18T19_35_31.jpg</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">selected_image_no_ext</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dtstr</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H-%M-%S&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="mi">785104</span><span class="p">,</span>
        <span class="mi">785105</span><span class="p">,</span>
        <span class="mi">785106</span><span class="p">,</span>
        <span class="mi">785107</span><span class="p">,</span>
        <span class="mi">785108</span><span class="p">,</span>
        <span class="mi">785109</span><span class="p">,</span>
        <span class="mi">785110</span><span class="p">,</span>
        <span class="mi">836457</span><span class="p">,</span>
        <span class="mi">867771</span><span class="p">,</span>
        <span class="mi">867772</span><span class="p">,</span>
        <span class="mi">867773</span><span class="p">,</span>
        <span class="mi">867774</span><span class="p">,</span>
        <span class="mi">867775</span><span class="p">,</span>
        <span class="mi">867776</span><span class="p">,</span>
        <span class="mi">867777</span><span class="p">,</span>
        <span class="mi">867778</span><span class="p">,</span>
        <span class="mi">867806</span><span class="p">,</span>
        <span class="mi">867807</span><span class="p">,</span>
        <span class="mi">867808</span><span class="p">,</span>
        <span class="mi">867852</span><span class="p">,</span>
        <span class="mi">867853</span><span class="p">,</span>
        <span class="mi">867861</span><span class="p">,</span>
        <span class="mi">873541</span><span class="p">,</span>
        <span class="mi">875713</span><span class="p">,</span>
        <span class="mi">875714</span><span class="p">,</span>
        <span class="mi">876422</span><span class="p">,</span>
        <span class="mi">876423</span><span class="p">,</span>
        <span class="mi">876511</span><span class="p">,</span>
        <span class="mi">876512</span><span class="p">,</span>
        <span class="mi">876513</span><span class="p">,</span>
        <span class="mi">876514</span><span class="p">,</span>
        <span class="mi">876515</span><span class="p">,</span>
        <span class="mi">876516</span><span class="p">,</span>
        <span class="mi">876517</span><span class="p">,</span>
        <span class="mi">876518</span><span class="p">,</span>
        <span class="mi">880043</span><span class="p">,</span>
        <span class="mi">880044</span><span class="p">,</span>
        <span class="mi">885666</span><span class="p">,</span>
        <span class="mi">885667</span><span class="p">,</span>
        <span class="mi">885668</span><span class="p">,</span>
        <span class="mi">885669</span><span class="p">,</span>
        <span class="mi">885670</span><span class="p">,</span>
        <span class="mi">885672</span><span class="p">,</span>
        <span class="mi">885674</span><span class="p">,</span>
        <span class="mi">885675</span><span class="p">,</span>
        <span class="mi">885709</span><span class="p">,</span>
        <span class="mi">885712</span><span class="p">,</span>
        <span class="mi">885713</span><span class="p">,</span>
        <span class="mi">885714</span><span class="p">,</span>
        <span class="mi">885715</span><span class="p">,</span>
        <span class="mi">885716</span><span class="p">,</span>
        <span class="mi">885717</span><span class="p">,</span>
        <span class="mi">885718</span><span class="p">,</span>
        <span class="mi">885719</span><span class="p">,</span>
        <span class="mi">885720</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Extracting missing datetime from filename for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># e.g. PP_107-100_2012-03-19.png</span>
        <span class="c1"># e.g. PP_100_2012-06-05a.jpg</span>
        <span class="c1"># e.g. TH_122_2012-03-27.jpg</span>
        <span class="c1"># e.g. J_05_2017_05_24a.jpg</span>
        <span class="c1"># e.g. J_overview_2017-05-24za.jpg</span>
        <span class="c1"># e.g. J_40_2017_08_11a.jpg</span>
        <span class="c1"># e.g. J_05_2017-08-11a.jpg</span>
        <span class="c1"># e.g. LG_OVERVIEW_01_05_06_07_09_2013_02_24a.jpg</span>
        <span class="c1"># e.g. LG_01_07_2010_11_11a.jpg</span>
        <span class="c1"># e.g. LG_01_2010_11_11a.jpg</span>
        <span class="c1"># e.g. LG_Cluster1_2012_01_31a.jpg</span>
        <span class="c1"># e.g. LG_01_07_2012_04_22a.jpg</span>
        <span class="c1"># e.g. LG_SCREW_2012_04_22a.jpg</span>
        <span class="c1"># e.g. So_01_2014_02_15b.jpg</span>
        <span class="c1"># e.g. XH_01_2013_01_12_a.jpg</span>
        <span class="c1"># e.g. XH_01%2B09_2013_11_19_a.jpg</span>
        <span class="c1"># e.g. XH_01_2010_04_22_a.jpg</span>
        <span class="c1"># e.g. LH_020_2015_01_28a_counted.jpg</span>
        <span class="c1"># e.g. LH_020_2015_01_28xx.jpg</span>
        <span class="c1"># e.g. J_J40%2BJ46%2BJ41_2016_09_25_a.jpg</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">selected_image_no_ext</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
            <span class="s2">&quot;abcdefghijklmnopqrstuvwxyz_-&quot;</span>
        <span class="p">)</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">dtstr</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="o">-</span><span class="mi">11</span><span class="p">:]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dtstr</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="mi">789211</span><span class="p">,</span>
        <span class="mi">789212</span><span class="p">,</span>
        <span class="mi">789213</span><span class="p">,</span>
        <span class="mi">789214</span><span class="p">,</span>
        <span class="mi">789215</span><span class="p">,</span>
        <span class="mi">789216</span><span class="p">,</span>
        <span class="mi">789219</span><span class="p">,</span>
        <span class="mi">819234</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Extracting missing datetime from filename for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># e.g. 2003_W01-2.jpg</span>
        <span class="c1"># e.g. 2004_B_bewachsen.jpg</span>
        <span class="c1"># e.g. 2005_B.jpg</span>
        <span class="c1"># e.g. 2013_B01-1.jpg</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">selected_image_no_ext</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="c1"># Test the format is correct; we will get an error if not</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dtstr</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y&quot;</span><span class="p">)</span>
        <span class="c1"># But we actually want to keep the lower precision string</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtstr</span>

    <span class="k">elif</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="mi">789217</span><span class="p">,</span>
        <span class="mi">793210</span><span class="p">,</span>
        <span class="mi">793211</span><span class="p">,</span>
        <span class="mi">818906</span><span class="p">,</span>
        <span class="mi">818907</span><span class="p">,</span>
        <span class="mi">836263</span><span class="p">,</span>
        <span class="mi">836264</span><span class="p">,</span>
        <span class="mi">836265</span><span class="p">,</span>
        <span class="mi">836266</span><span class="p">,</span>
        <span class="mi">837653</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Extracting missing datetime from filename for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># e.g. 04_2011.jpg</span>
        <span class="c1"># e.g. 04a_2011_analog.jpg</span>
        <span class="c1"># e.g. 04.2-2008.jpg</span>
        <span class="c1"># e.g. 08-2008.jpg</span>
        <span class="c1"># e.g. 04a_2013.jpg</span>
        <span class="c1"># e.g. 05a_2003.jpg</span>
        <span class="c1"># e.g. 04_2007.jpg</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">selected_image_no_ext</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span>
            <span class="s2">&quot;abcdefghijklmnopqrstuvwxyz_-&quot;</span>
        <span class="p">)</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">dtstr</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span>
        <span class="c1"># Test the format is correct; we will get an error if not</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dtstr</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y&quot;</span><span class="p">)</span>
        <span class="c1"># But we actually want to keep the lower precision string</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtstr</span>

    <span class="k">elif</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">836024</span><span class="p">,</span> <span class="mi">836025</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Extracting missing datetime from filename for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># e.g. 00setting_2014-08.jpg</span>
        <span class="c1"># e.g. 39.9_2014.jpg</span>
        <span class="c1"># e.g. 2014_B01-1.jpg</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;2014&quot;</span>

    <span class="k">elif</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">840699</span><span class="p">,</span> <span class="mi">840700</span><span class="p">,</span> <span class="mi">840702</span><span class="p">,</span> <span class="mi">840703</span><span class="p">,</span> <span class="mi">840742</span><span class="p">,</span> <span class="mi">840743</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Extracting missing datetime from filename for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># e.g. J_001_2012-01-31.jpg</span>
        <span class="c1"># e.g. J_003_2012-01-31_2.jpg</span>
        <span class="c1"># e.g. J_115_2012-01-31_a.jpg</span>
        <span class="c1"># e.g. J_033_2012-08-08.jpg</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">selected_image_no_ext</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">dtstr</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dtstr</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">840701</span><span class="p">,</span> <span class="mi">849298</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Extracting missing datetime from filename for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># e.g. J_002_2013-03_03a.jpg</span>
        <span class="c1"># e.g. J_001_2015-01.jpg</span>
        <span class="c1"># e.g. J_001_2015-01_a.jpg</span>
        <span class="c1"># e.g. J_056_2013-03_06logger.jpg</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">selected_image_no_ext</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="c1"># Test the format is correct; we will get an error if not</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dtstr</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m&quot;</span><span class="p">)</span>
        <span class="c1"># But we actually want to keep the lower precision string</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtstr</span>

    <span class="k">elif</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">872407</span><span class="p">,</span> <span class="mi">872408</span><span class="p">,</span> <span class="mi">872409</span><span class="p">,</span> <span class="mi">872410</span><span class="p">,</span> <span class="mi">872411</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Extracting missing datetime from filename for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># e.g. J_40_2017-01-12_a.jpg</span>
        <span class="c1"># e.g. J_overview2_2017-02-02_x.jpg</span>
        <span class="c1"># e.g. J_xx_2017-01-12_x-62.jpg</span>
        <span class="c1"># e.g. J_17_2017-01-14.jpg</span>
        <span class="c1"># e.g. J_23_2017-01-14_b-1.jpg</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">selected_image_no_ext</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dtstr</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">878045</span><span class="p">,</span> <span class="mi">888410</span><span class="p">]:</span>
        <span class="c1"># Nothing to do</span>
        <span class="k">pass</span>

    <span class="k">elif</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">894734</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Extracting missing datetime from filename for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># e.g. HOTKEY_2018_03_27at21_09_21CP4A4682</span>
        <span class="c1"># e.g. TIMER_2018_03_18at04_04_09CP4A3970</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">selected_image_no_ext</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])[:</span><span class="mi">20</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dtstr</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">at%H_%M_%S&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">896157</span><span class="p">,</span> <span class="mi">896160</span><span class="p">,</span> <span class="mi">896164</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Extracting missing datetime from filename for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># e.g. 2016-08-2600000.jpg</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">selected_image_no_ext</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dtstr</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="mi">918232</span><span class="p">,</span>
        <span class="mi">918233</span><span class="p">,</span>
        <span class="mi">918327</span><span class="p">,</span>
        <span class="mi">918340</span><span class="p">,</span>
        <span class="mi">918341</span><span class="p">,</span>
        <span class="mi">918382</span><span class="p">,</span>
        <span class="mi">918383</span><span class="p">,</span>
        <span class="mi">918385</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Extracting missing datetime from filename for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># e.g. XH_01_2010_04_22_a.jpg</span>
        <span class="c1"># e.g. XH_01_2010_04_28a.jpg</span>
        <span class="c1"># e.g. XH_03_2018_10_18_a-1.jpg</span>
        <span class="n">dtstr</span> <span class="o">=</span> <span class="n">selected_image_no_ext</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">])[:</span><span class="mi">10</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dtstr</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="add_missing_datetime"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.add_missing_datetime">[docs]</a><span class="k">def</span> <span class="nf">add_missing_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ds_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add missing datetime values using either the mean extent or extraction from the file name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input dataframe.</span>
<span class="sd">    ds_id : int, optional</span>
<span class="sd">        The identifier of the PANGAEA dataset. The default behaviour is to</span>
<span class="sd">        extract this from the dataset column of the dataframe.</span>
<span class="sd">    verbose : int, default=1</span>
<span class="sd">        Verbosity level.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        As input, but with missing datetime cells completed, either by using the</span>
<span class="sd">        average from the datetime extent metadata, or by extracting it from the</span>
<span class="sd">        image name.</span>
<span class="sd">        All existing datetime values are left unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;datetime&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Get dataset id from first row</span>
        <span class="n">ds_id</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ds_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ds_id</span><span class="p">)</span>

    <span class="c1"># Add datetimes that are still missing by inferring from the image filename</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">fix_missing_datetime_from_image_name</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ds_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()):</span>
        <span class="c1"># This dataset has no datetime values</span>
        <span class="c1"># Try to determine average datetime from the datetime extent metadata on</span>
        <span class="c1"># the dataset record</span>
        <span class="n">dt_avg</span> <span class="o">=</span> <span class="n">get_dataset_datetime</span><span class="p">(</span><span class="n">ds_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dt_avg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Using average datetime from extent&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; - filenames look like </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_avg</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()):</span>
        <span class="c1"># This dataframe already has all datetime information</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">select</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">889035</span><span class="p">,</span> <span class="mi">889025</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Adding manual missing datetime for </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># From the abstract on PANGAEA (sic):</span>
        <span class="c1"># Experimet was setup during 2007-02-15 and 2007-06-13.</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;2007&quot;</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">896160</span><span class="p">,</span> <span class="mi">896164</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Adding manual missing datetime for </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># From the INDEX 2016 ROV (see dataset title and paper</span>
        <span class="c1"># https://doi.org/10.3389/fmars.2019.00096)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;2016&quot;</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="interpolate_by_datetime"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.interpolate_by_datetime">[docs]</a><span class="k">def</span> <span class="nf">interpolate_by_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use datetime column to interpolate values for selected columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Dataframe with ``&quot;datetime&quot;`` column, which may contain missing values</span>
<span class="sd">        in other columns.</span>
<span class="sd">    columns : str or iterable of str</span>
<span class="sd">        Name of column or columns to fill in missing values with interpolation.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional arguments as per :func:`numpy.interp`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Like input, but with missing values in specified columns completed by</span>
<span class="sd">        linear interpolation over datetime.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert datetime string to a datetime object</span>
    <span class="n">datetime_actual</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
    <span class="n">has_datetime</span> <span class="o">=</span> <span class="o">~</span><span class="n">datetime_actual</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">interp_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;depth_of_observer&quot;</span><span class="p">,</span> <span class="s2">&quot;bathymetry&quot;</span><span class="p">,</span> <span class="s2">&quot;altitude&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s2">&quot;left&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interp_kwargs</span><span class="p">:</span>
                <span class="n">interp_kwargs</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="s2">&quot;right&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interp_kwargs</span><span class="p">:</span>
                <span class="n">interp_kwargs</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">has_col</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="n">has_dt_and_col</span> <span class="o">=</span> <span class="n">has_datetime</span> <span class="o">&amp;</span> <span class="n">has_col</span>
        <span class="n">has_dt_not_col</span> <span class="o">=</span> <span class="n">has_datetime</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">has_col</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_dt_not_col</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">datetime_actual</span><span class="p">[</span><span class="n">has_dt_not_col</span><span class="p">],</span>
            <span class="n">datetime_actual</span><span class="p">[</span><span class="n">has_dt_and_col</span><span class="p">],</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_dt_and_col</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
            <span class="o">**</span><span class="n">interp_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="fixup_incomplete_metadata"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.fixup_incomplete_metadata">[docs]</a><span class="k">def</span> <span class="nf">fixup_incomplete_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ds_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fix datasets which have partial, but incomplete, lat/lon/datetime metadata.</span>

<span class="sd">    Interpolation is performed as appropriate to the dataset. The methodology</span>
<span class="sd">    was determined by manually inspecting each dataset.</span>
<span class="sd">    Any latitude and longitude values which can not be resolved are filled in</span>
<span class="sd">    with the dataset-level mean latitude and longitude as reported by PANGAEA.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Input dataframe.</span>
<span class="sd">    ds_id : int, optional</span>
<span class="sd">        The identifier of the PANGAEA dataset. The default behaviour is to</span>
<span class="sd">        extract this from the dataset column of the dataframe.</span>
<span class="sd">    verbose : int, default=1</span>
<span class="sd">        Verbosity level.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        As input, but with missing datetime, latitude, longitude, and/or depth</span>
<span class="sd">        cells completed by interpolation or similar.</span>
<span class="sd">        All existing datetime values are left unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Get dataset id from first row</span>
        <span class="n">ds_id</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ds_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ds_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">753197</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Fixing missing metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nothing to be done.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">805606</span><span class="p">,</span> <span class="mi">805607</span><span class="p">,</span> <span class="mi">805611</span><span class="p">,</span> <span class="mi">805612</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Fixing missing metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Interpolating by index&quot;</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;datetime&quot;</span>
        <span class="n">select_not_col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="n">select_has_col</span> <span class="o">=</span> <span class="o">~</span><span class="n">select_not_col</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">select_has_col</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">select_not_col</span><span class="p">):</span>
            <span class="n">missing_timestamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">indices</span><span class="p">[</span><span class="n">select_not_col</span><span class="p">],</span>
                <span class="n">indices</span><span class="p">[</span><span class="n">select_has_col</span><span class="p">],</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_has_col</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_not_col</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ts</span><span class="p">))</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">missing_timestamps</span>
            <span class="p">]</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="o">==</span> <span class="mi">875080</span><span class="p">:</span>
        <span class="c1"># N.B. There is date metadata in the csv, but not time. But there is time</span>
        <span class="c1"># metadata in the filename, so we could extract this if we wanted to.</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Fixing missing metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nothing to be done.&quot;</span><span class="p">)</span>
        <span class="c1"># lat/lon was only recorded for the first 11 images. Fill in the rest</span>
        <span class="c1"># with the median latitude and longitude for the record at the end</span>
        <span class="c1"># of this function.</span>

    <span class="k">if</span> <span class="mi">873995</span> <span class="o">&lt;=</span> <span class="n">ds_id</span> <span class="o">&lt;=</span> <span class="mi">874002</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interpolating latitude, longitude, and depth for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Interpolate lat, lon, and depth based on datetime</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">interpolate_by_datetime</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;depth_of_observer&quot;</span><span class="p">,</span> <span class="s2">&quot;bathymetry&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">875071</span><span class="p">,</span> <span class="mi">875073</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Fixing missing metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Drop rows without datetime values (these have missing lat/lon as well)</span>
        <span class="c1"># For 875071, these images are of the deck of the ship.</span>
        <span class="c1"># For 875073, these images have a translation of less than half an image</span>
        <span class="c1"># from the subsequent image, so we don&#39;t need the ones without metadata.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="c1"># Interpolate missing depth values</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">interpolate_by_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;depth_of_observer&quot;</span><span class="p">,</span> <span class="s2">&quot;bathymetry&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">875084</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Fixing missing metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># For 875084, images without latitude and longitude are not useful.</span>
        <span class="c1"># The first three are of the deck, the rest are dark watercolumn shots.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="c1"># Interpolate missing depth values</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">interpolate_by_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;depth_of_observer&quot;</span><span class="p">,</span> <span class="s2">&quot;bathymetry&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">878001</span> <span class="o">&lt;=</span> <span class="n">ds_id</span> <span class="o">&lt;=</span> <span class="mi">878019</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ds_id</span> <span class="o">==</span> <span class="mi">878045</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Dropping rows missing metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Images without metadata are of the water column and highly redundant.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">894732</span><span class="p">,</span> <span class="mi">894734</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Dropping rows missing metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># It&#39;s not clear to me that any of these images are of the seafloor.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">895557</span><span class="p">,</span> <span class="mi">903782</span><span class="p">,</span> <span class="mi">903788</span><span class="p">,</span> <span class="mi">903850</span><span class="p">,</span> <span class="mi">907025</span><span class="p">,</span> <span class="mi">894801</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Fixing missing metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Interpolating by index over subset of images in the same series&quot;</span>
            <span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="n">image_no_ext</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">image_major</span> <span class="o">=</span> <span class="n">image_no_ext</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">missing_dt</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="n">missing_lat</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="n">missing_lon</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">image_major_i</span> <span class="ow">in</span> <span class="n">image_major</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">select</span> <span class="o">=</span> <span class="n">image_major</span> <span class="o">==</span> <span class="n">image_major_i</span>
            <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;latitude&quot;</span>
            <span class="n">select_and_col</span> <span class="o">=</span> <span class="n">select</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">missing_lat</span>
            <span class="n">select_not_col</span> <span class="o">=</span> <span class="n">select</span> <span class="o">&amp;</span> <span class="n">missing_lat</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">select_and_col</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">select_not_col</span><span class="p">):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_not_col</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">indices</span><span class="p">[</span><span class="n">select_not_col</span><span class="p">],</span>
                    <span class="n">indices</span><span class="p">[</span><span class="n">select_and_col</span><span class="p">],</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_and_col</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;longitude&quot;</span>
            <span class="n">select_and_col</span> <span class="o">=</span> <span class="n">select</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">missing_lon</span>
            <span class="n">select_not_col</span> <span class="o">=</span> <span class="n">select</span> <span class="o">&amp;</span> <span class="n">missing_lon</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">select_and_col</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">select_not_col</span><span class="p">):</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_not_col</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">indices</span><span class="p">[</span><span class="n">select_not_col</span><span class="p">],</span>
                    <span class="n">indices</span><span class="p">[</span><span class="n">select_and_col</span><span class="p">],</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_and_col</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;datetime&quot;</span>
            <span class="n">select_and_col</span> <span class="o">=</span> <span class="n">select</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">missing_dt</span>
            <span class="n">select_not_col</span> <span class="o">=</span> <span class="n">select</span> <span class="o">&amp;</span> <span class="n">missing_dt</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">select_and_col</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">select_not_col</span><span class="p">):</span>
                <span class="n">new_values</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
                    <span class="n">indices</span><span class="p">[</span><span class="n">select_and_col</span><span class="p">],</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_and_col</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                        <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">timestamp</span>
                    <span class="p">),</span>
                    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                    <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">,</span>
                <span class="p">)(</span><span class="n">indices</span><span class="p">[</span><span class="n">select_not_col</span><span class="p">])</span>
                <span class="n">new_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">new_values</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
                <span class="n">new_values</span> <span class="o">=</span> <span class="n">new_values</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_not_col</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_values</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">911904</span><span class="p">,</span> <span class="mi">918924</span><span class="p">,</span> <span class="mi">919348</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Extracting missing datetime metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Extract missing datetime from the filename, formatted like (e.g.)</span>
        <span class="c1"># TIMER_2019_03_31_at_05_50_12_IMG_0263</span>
        <span class="n">has_no_datetime</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="n">fname_inner</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_no_datetime</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">has_no_datetime</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="n">fname_inner</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y_%m_</span><span class="si">%d</span><span class="s2">_at_%H_%M_%S&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Interpolating latitude, longitude, and depth for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">interpolate_by_datetime</span><span class="p">(</span>
            <span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;depth_of_observer&quot;</span><span class="p">,</span> <span class="s2">&quot;bathymetry&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">914155</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Fixing missing metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Images without datetime are too dark</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="c1"># Other images are missing latitude and longitude metadata</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">interpolate_by_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">914156</span><span class="p">,</span> <span class="mi">914197</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Fixing missing metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Some images are clearly of the same thing, but one is good visibility</span>
        <span class="c1"># with no lat/lon, and the next is too dark and has no datetime.</span>
        <span class="k">for</span> <span class="n">from_image</span><span class="p">,</span> <span class="n">to_image</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;IMG_0393&quot;</span><span class="p">,</span> <span class="s2">&quot;IMG_0392&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;IMG_0395&quot;</span><span class="p">,</span> <span class="s2">&quot;IMG_0394&quot;</span><span class="p">),</span>
        <span class="p">]:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">]</span>
            <span class="n">select_from</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">from_image</span><span class="p">)</span>
            <span class="n">select_to</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">to_image</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_to</span><span class="p">,</span> <span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_from</span><span class="p">,</span> <span class="n">columns</span><span class="p">]</span>
        <span class="c1"># Drop images without datetime</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="c1"># Fill in any missing latitude and longitude metadata</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">interpolate_by_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">914192</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Fixing missing metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Some images are clearly of the same thing, but one is good visibility</span>
        <span class="c1"># with no lat/lon, and the next is too dark and has no datetime.</span>
        <span class="k">for</span> <span class="n">from_image</span><span class="p">,</span> <span class="n">to_image</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;IMG_1776&quot;</span><span class="p">,</span> <span class="s2">&quot;IMG_1775&quot;</span><span class="p">),</span>
        <span class="p">]:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">]</span>
            <span class="n">select_from</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">from_image</span><span class="p">)</span>
            <span class="n">select_to</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">to_image</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_to</span><span class="p">,</span> <span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_from</span><span class="p">,</span> <span class="n">columns</span><span class="p">]</span>
        <span class="c1"># Drop images without datetime</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="c1"># Fill in any missing latitude and longitude metadata</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">interpolate_by_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="p">(</span><span class="mi">702075</span> <span class="o">&lt;=</span> <span class="n">ds_id</span> <span class="o">&lt;=</span> <span class="mi">702080</span><span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span><span class="mi">818484</span> <span class="o">&lt;=</span> <span class="n">ds_id</span> <span class="o">&lt;=</span> <span class="mi">818509</span><span class="p">)</span>
        <span class="ow">or</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">849287</span><span class="p">,</span> <span class="mi">849289</span><span class="p">]</span>
        <span class="ow">or</span> <span class="mi">862084</span> <span class="o">&lt;=</span> <span class="n">ds_id</span> <span class="o">&lt;=</span> <span class="mi">862097</span>
        <span class="ow">or</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">875072</span><span class="p">,</span> <span class="mi">875074</span><span class="p">]</span>
        <span class="ow">or</span> <span class="mi">875081</span> <span class="o">&lt;=</span> <span class="n">ds_id</span> <span class="o">&lt;=</span> <span class="mi">875085</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Interpolating missing depth metadata for dataset </span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">interpolate_by_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;depth_of_observer&quot;</span><span class="p">,</span> <span class="s2">&quot;bathymetry&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">|</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()):</span>
        <span class="c1"># Fill in any missing latitude and longitude values with the</span>
        <span class="c1"># mean coordinate reported at the dataset level</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">PanDataSet</span><span class="p">(</span><span class="n">ds_id</span><span class="p">,</span> <span class="n">enable_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s2">&quot;geometryextent&quot;</span><span class="p">):</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">long</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;meanLatitude&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;Latitude&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">geometryextent</span><span class="p">:</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">geometryextent</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;meanLongitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;Latitude&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">geometryextent</span><span class="p">:</span>
                    <span class="n">long</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">geometryextent</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Using dataset mean latitude for missing values&quot;</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lat</span>
            <span class="k">if</span> <span class="n">long</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">: Using dataset mean longitude for missing values&quot;</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">long</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="merge_duplicated_urls"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.merge_duplicated_urls">[docs]</a><span class="k">def</span> <span class="nf">merge_duplicated_urls</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge metadata across rows which have the same URL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Original number of rows:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of rows after dropping simple duplicates:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
    <span class="c1"># Record the original sort index so we can get the data back in the original</span>
    <span class="c1"># order.</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;original_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="c1"># Determine how many images are at the same location. This indicates how</span>
    <span class="c1"># accurate the latitude and longitude information is. We will want to keep</span>
    <span class="c1"># the most accurate version of this.</span>
    <span class="n">repeat_location_counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">repeat_location_counts</span> <span class="o">=</span> <span class="n">repeat_location_counts</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
    <span class="n">repeat_location_counts</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;tally_repeated_location&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Add the tally_repeated_location data as a new column</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">repeat_location_counts</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">resolve_duplicates</span><span class="p">(</span><span class="n">sdf</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sdf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If there&#39;s only one row in the group, return it.</span>
            <span class="k">return</span> <span class="n">sdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Take the entry which has the fewest repetitions of the latitude and</span>
        <span class="c1"># longitude value. We will use the version from the first dataset that</span>
        <span class="c1"># had the fewest repetitions of the location for this image.</span>
        <span class="c1"># We adopt this row&#39;s collection, dataset, and site values in addition</span>
        <span class="c1"># to its coordinates.</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;tally_repeated_location&quot;</span><span class="p">])</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># For numeric columns (other than latitude and longitude), take the</span>
        <span class="c1"># average of the values where they are present.</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;depth_of_observer&quot;</span><span class="p">,</span>
            <span class="s2">&quot;altitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bathymetry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;salinity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;acidity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">select</span> <span class="o">=</span> <span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">select</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">select</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="c1"># Look to see if we are missing an image or thumbnail entry and one</span>
        <span class="c1"># of the duplicates has its value.</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;url_thumbnail&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">values</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># For datetime, use the fact that we encoded datetime as a string</span>
        <span class="c1"># with varying levels of precision. More digits means higher precision.</span>
        <span class="c1"># Take the most precise value, preferring the value from the selected</span>
        <span class="c1"># record in the event of a tie.</span>
        <span class="n">datetime_len</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; 00:00:00&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
        <span class="n">idx_dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">datetime_len</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datetime_len</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">datetime_len</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_dt</span><span class="p">]:</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_dt</span><span class="p">][</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Merging metadata between rows with the same URL&quot;</span><span class="p">)</span>
    <span class="c1"># Group by URL and apply our transformation to each group</span>
    <span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">progress_apply</span><span class="p">(</span><span class="n">resolve_duplicates</span><span class="p">)</span>
    <span class="c1"># Reorder the dataframe to preseve implicit temporal information from the</span>
    <span class="c1"># ordering of the images</span>
    <span class="n">df_out</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;original_index&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_out</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;original_index&quot;</span><span class="p">,</span> <span class="s2">&quot;tally_repeated_location&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_out</span></div>


<div class="viewcode-block" id="process_single"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.process_single">[docs]</a><span class="k">def</span> <span class="nf">process_single</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ds_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">remove_duplicate_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reformat and cleanup metadata for a single dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.Dataframe</span>
<span class="sd">        The dataset to process.</span>
<span class="sd">    ds_id : int, optional</span>
<span class="sd">        The ID number for the PANGAEA dataset. If omitted, it is inferred from</span>
<span class="sd">        the ``ds_id`` column of ``df``.</span>
<span class="sd">    verbose : int, default=1</span>
<span class="sd">        Verbosity level.</span>
<span class="sd">    remove_duplicate_columns : bool, default=False</span>
<span class="sd">        Whether to remove duplicate column names.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.Dataframe</span>
<span class="sd">        A processed copy of the dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ds_id</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;ds_id&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">ds_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ds_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="s2">&quot;ds_id&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ds_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pangaea-&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ds_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ds_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ds_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;pangaea-pangaea-&quot;</span><span class="p">,</span> <span class="s2">&quot;pangaea-&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ds_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pangaea-</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;parent_ds_id&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;parent_ds_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pangaea-&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;parent_ds_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;parent_ds_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;parent_ds_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;pangaea-pangaea-&quot;</span><span class="p">,</span> <span class="s2">&quot;pangaea-&quot;</span>
        <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">reformat_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">remove_duplicate_columns</span><span class="o">=</span><span class="n">remove_duplicate_columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">url_col</span> <span class="o">=</span> <span class="s2">&quot;url&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">url_col</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">filter_urls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">url_column</span><span class="o">=</span><span class="n">url_col</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># Drop rows that are complete duplicates</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Try to fix repeated URLs that are accidental dups but should differ</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">fixup_repeated_urls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">url_column</span><span class="o">=</span><span class="n">url_col</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Check for any rows that are all NaNs</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s2">&quot;columns&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2"> has a row which is all NaNs&quot;</span><span class="p">)</span>

    <span class="c1"># Remove duplicated &quot;favourited&quot; images</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">fixup_favourite_images</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Fix incomplete lat/lon/datetime metadata</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">fixup_incomplete_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ds_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Add datetime if it is completely missing</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">add_missing_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ds_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="process_datasets"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.process_datasets">[docs]</a><span class="k">def</span> <span class="nf">process_datasets</span><span class="p">(</span><span class="n">input_dirname</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a directory of datasets: clean, concatenate and save.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_dirname : str</span>
<span class="sd">        Path to directory containing CSV files.</span>
<span class="sd">    output_path : str, optional</span>
<span class="sd">        The output filename. Default is ``input_dirname + &quot;.csv&quot;``.</span>
<span class="sd">    verbose : int, default=0</span>
<span class="sd">        Level of verbosity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">input_dirname</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing directory </span><span class="si">{</span><span class="n">input_dirname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Will save as </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">column_count</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">column_examples</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[])</span>
    <span class="n">files_without_url</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">files_with_repeat_urls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">files_with_repeat_urls2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_valid</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dfs_fnames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ids_with_potential_labels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">input_dirname</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)):</span>  <span class="c1"># noqa: C414</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># for fname in tqdm(os.listdir(input_dirname)):</span>
        <span class="n">ds_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;805690&quot;</span><span class="p">,</span> <span class="s2">&quot;803979&quot;</span><span class="p">]:</span>
            <span class="c1"># The title was not captured from this dataset for some reason,</span>
            <span class="c1"># so we can&#39;t exclude it via the title.</span>
            <span class="k">continue</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_dirname</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">n_total</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">checker</span><span class="o">.</span><span class="n">has_url_col</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">url_col</span> <span class="o">=</span> <span class="n">find_url_column</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url_col</span><span class="p">:</span>
            <span class="n">files_without_url</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="s2">&quot;ds_id&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ds_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pangaea-&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ds_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ds_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pangaea-</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;parent_ds_id&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;parent_ds_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pangaea-&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;parent_ds_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">reformat_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">url_col</span> <span class="o">=</span> <span class="s2">&quot;url&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">url_col</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">filter_urls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">url_column</span><span class="o">=</span><span class="n">url_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">n_valid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">column_count</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">column_examples</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="c1"># &quot;Type&quot;,</span>
            <span class="s2">&quot;Content&quot;</span><span class="p">,</span>  <span class="c1"># Yes!</span>
            <span class="c1"># &quot;Sample label&quot;,</span>
            <span class="c1"># &quot;ID&quot;,</span>
            <span class="c1"># &quot;Sample ID&quot;,</span>
            <span class="s2">&quot;Classification&quot;</span><span class="p">,</span>  <span class="c1"># Yes!</span>
            <span class="s2">&quot;Species&quot;</span><span class="p">,</span>  <span class="c1"># Yes!</span>
            <span class="c1"># &quot;Reference&quot;,</span>
            <span class="c1"># &quot;Samp type&quot;,</span>
            <span class="s2">&quot;Family&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Genus&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;Ind No&quot;,</span>
            <span class="c1"># &quot;Imagery&quot;,</span>
            <span class="c1"># &quot;Img brightness&quot;,  # No</span>
            <span class="s2">&quot;Ground vis&quot;</span><span class="p">,</span>  <span class="c1"># Yes!</span>
            <span class="s2">&quot;Marine litter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Fisheries plastic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Unident litter&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ids_with_potential_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds_id</span><span class="p">)</span>

        <span class="c1"># Drop rows that are complete duplicates</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">url_col</span><span class="p">)):</span>
            <span class="n">files_with_repeat_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="c1"># Try to fix repeated URLs that are accidental dups but should differ</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">fixup_repeated_urls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">url_column</span><span class="o">=</span><span class="n">url_col</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">url_col</span><span class="p">)):</span>
            <span class="n">files_with_repeat_urls2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="c1"># Check for any rows that are all NaNs</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="s2">&quot;columns&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds_id</span><span class="si">}</span><span class="s2"> has a row which is all NaNs&quot;</span><span class="p">)</span>

        <span class="c1"># Remove duplicated &quot;favourited&quot; images</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">fixup_favourite_images</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Fix incomplete lat/lon/datetime metadata</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">fixup_incomplete_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ds_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Add datetime if it is completely missing</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">add_missing_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ds_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">dfs_fnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="n">n_valid</span><span class="si">}</span><span class="s2"> valid (of </span><span class="si">{</span><span class="n">n_total</span><span class="si">}</span><span class="s2">) valid datasets&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Of which </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files_with_repeat_urls</span><span class="p">)</span><span class="si">}</span><span class="s2"> have repeated URLs (before replacing dups with image)&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files_with_repeat_urls</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Of which </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files_with_repeat_urls2</span><span class="p">)</span><span class="si">}</span><span class="s2"> have repeated URLs (after replacing dups with image)&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files_with_repeat_urls2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">column_count</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique column names:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">column_count</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">.&lt;35s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">count</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="n">ids_with_potential_labels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ids_with_potential_labels</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ids_with_potential_labels</span><span class="p">)</span><span class="si">}</span><span class="s2"> datasets which might have labels to extract:&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">ds_id</span> <span class="ow">in</span> <span class="n">ids_with_potential_labels</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ds_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filter columns&quot;</span><span class="p">)</span>
    <span class="c1"># Select only columns of interest</span>
    <span class="n">select_cols</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dataset&quot;</span><span class="p">,</span>
        <span class="s2">&quot;site&quot;</span><span class="p">,</span>
        <span class="s2">&quot;url&quot;</span><span class="p">,</span>
        <span class="s2">&quot;url_thumbnail&quot;</span><span class="p">,</span>
        <span class="s2">&quot;image&quot;</span><span class="p">,</span>
        <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;area&quot;</span><span class="p">,</span>
        <span class="s2">&quot;altitude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;depth_of_observer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bathymetry&quot;</span><span class="p">,</span>
        <span class="s2">&quot;backscatter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;temperature&quot;</span><span class="p">,</span>
        <span class="s2">&quot;salinity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;chlorophyll&quot;</span><span class="p">,</span>
        <span class="s2">&quot;acidity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parent_ds_id&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">select_cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">df_all</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;parent_ds_id&quot;</span><span class="p">:</span> <span class="s2">&quot;collection&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_all</span><span class="p">)</span><span class="si">}</span><span class="s2"> records before dropping duplicated URLs&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">output_path_with_dups</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">output_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_with-duplicates.csv&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving (with duplicates) to </span><span class="si">{</span><span class="n">output_path_with_dups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df_all</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path_with_dups</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Remove duplicate URLs</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Merge duplicated URLs&quot;</span><span class="p">)</span>
    <span class="c1"># Convert datetime to string</span>
    <span class="n">df_all</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_all</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">df_all</span> <span class="o">=</span> <span class="n">merge_duplicated_urls</span><span class="p">(</span><span class="n">df_all</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_all</span><span class="p">)</span><span class="si">}</span><span class="s2"> records after dropping duplicated URLs&quot;</span><span class="p">)</span>

    <span class="c1"># Fix repeated output paths by replacing with image field</span>
    <span class="k">if</span> <span class="n">fixup_repeated_output_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skip fix repeated output paths step (requires benthicnet package)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fix repeated output paths to prevent collisions&quot;</span><span class="p">)</span>
        <span class="n">df_all</span> <span class="o">=</span> <span class="n">fixup_repeated_output_paths</span><span class="p">(</span><span class="n">df_all</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving (without duplicates) to </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df_all</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_parser"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.get_parser">[docs]</a><span class="k">def</span> <span class="nf">get_parser</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build CLI parser for processing PANGAEA datasets.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    parser : argparse.ArgumentParser</span>
<span class="sd">        CLI argument parser.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">textwrap</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">prog</span> <span class="o">==</span> <span class="s2">&quot;__main__.py&quot;</span> <span class="ow">or</span> <span class="n">prog</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="n">prog</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Process downloaded PANGAEA datasets.&quot;</span><span class="p">,</span>
        <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--help&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-h&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;help&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show this help message and exit.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--version&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-V&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(prog)s</span><span class="s2"> </span><span class="si">{version}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">__meta__</span><span class="o">.</span><span class="n">version</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show program&#39;s version number and exit.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;input_dirname&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The query string(s) to search for and download.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--output-path&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output CSV file name.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Increase the level of verbosity of the program. This can be</span>
<span class="sd">            specified multiple times, each will increase the amount of detail</span>
<span class="sd">            printed to the terminal. The default verbosity level is %(default)s.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--quiet&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-q&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Decrease the level of verbosity of the program. This can be</span>
<span class="sd">            specified multiple times, each will reduce the amount of detail</span>
<span class="sd">            printed to the terminal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../source/packages/pangaea_downloader.merge_benthic_datasets.html#pangaea_downloader.merge_benthic_datasets.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run command line interface for cleaning and merging datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">get_parser</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;verbose&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;quiet&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">process_datasets</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Amit Baroi
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, Amit Baroi.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>